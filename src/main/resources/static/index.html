<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrisisConnect - Offline Ready Dashboard</title>

    <script src="js/qrcode.min.js"></script>
    <script src="js/sockjs.min.js"></script>
    <script src="js/stomp.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #0b0f1a; --bg-card: #161b2c; --accent: #3b82f6;
            --danger: #ef4444; --success: #22c55e; --warning: #f59e0b; --text-p: #94a3b8; --text-h: #f1f5f9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: var(--bg-deep); color: var(--text-h); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        .navbar { height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 1px solid #2d3748; background: var(--bg-deep); flex-shrink: 0; }
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .logo-box { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent), #1d4ed8); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .logo-text { font-size: 24px; font-weight: 800; color: #fff; }
        .logo-text span { color: var(--accent); }

        .nav-right { display: flex; align-items: center; gap: 25px; }
        .nav-stats { display: flex; gap: 30px; }
        .stat-item { text-align: center; }
        .stat-val { display: block; font-size: 18px; font-weight: 700; color: #fff; }
        .stat-lbl { font-size: 9px; color: var(--text-p); text-transform: uppercase; letter-spacing: 1px; }

        .online-indicator { display: flex; align-items: center; gap: 8px; background: #1a202e; padding: 6px 14px; border-radius: 20px; border: 1px solid #2d3748; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; position: relative; }
        .online { background: var(--success); }
        .online::after { content: ''; position: absolute; width:100%; height:100%; border-radius:50%; background:inherit; animation: pulse 2s infinite; }
        .offline { background: var(--danger) !important; }
        .offline-text { color: var(--danger); }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(2.5); opacity: 0; } }

        .notif-wrapper { position: relative; cursor: pointer; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 10px; font-weight: 800; padding: 2px 5px; border-radius: 50%; display: none; border: 2px solid var(--bg-deep); }
        .notif-dropdown { position: absolute; top: 45px; right: 0; width: 280px; background: var(--bg-card); border: 1px solid #2d3748; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; z-index: 1001; max-height: 350px; overflow-y: auto; }
        .notif-item { padding: 12px; border-bottom: 1px solid #1e293b; font-size: 12px; transition: 0.2s; }
        .notif-item:hover { background: rgba(255,255,255,0.03); }
        .notif-user { font-weight: 700; color: #fff; display: block; }
        .notif-msg { color: var(--text-p); }

        .app-main { display: grid; grid-template-columns: 300px 1fr; flex-grow: 1; overflow: hidden; }
        .sidebar { background: var(--bg-card); padding: 20px; border-right: 1px solid #2d3748; overflow: auto; display: flex; flex-direction: column; }
        .side-label { font-size: 11px; font-weight: 700; color: var(--text-p); text-transform: uppercase; margin: 15px 0 10px; display: block; }
        .status-dropdown { width: 100%; background: #0b0f1a; border: 1px solid #2d3748; color: white; padding: 12px; border-radius: 12px; outline: none; }

        .chat-container { display: flex; flex-direction: column; background: #080c14; overflow: hidden; position: relative; }
        .messages { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .filter-on .msg-wrap:not(.emergency) { display: none; }

        .bubble-container {
            display: flex;
            gap: 10px;
            padding-bottom: 15px;
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
        }
        .bubble-container::-webkit-scrollbar { display: none; } /* Chrome/Safari */

        .quick-bubble {
            padding: 8px 18px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .quick-bubble:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .quick-bubble:active { transform: scale(0.95); }

        .msg-wrap { display: flex; align-items: flex-end; gap: 10px; max-width: 80%; }
        .msg-left { align-self: flex-start; }
        .msg-right { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 800; color: white; flex-shrink: 0; cursor: pointer; }
        .msg-bubble { padding: 12px 18px; font-size: 14px; border-radius: 18px; line-height: 1.4; position: relative; transition: all 0.4s; }
        .msg-left .msg-bubble { background: #1e293b; color: #f1f5f9; border-bottom-left-radius: 4px; }
        .msg-right .msg-bubble { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .msg-sender { font-size: 10px; font-weight: 700; color: var(--text-p); margin-bottom: 4px; display: block; }
        .msg-time { font-size: 9px; color: var(--text-p); margin-top: 4px; display: block; }

        .msg-wrap.emergency { align-self: center; width: 90%; display: flex !important; align-items: center; }
        .msg-wrap.emergency .msg-bubble { border: 2px dashed var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.1); font-weight: 800; text-align: center; }

        .status-card { background: #0b0f1a; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--success); cursor: pointer; }
        .status-card.critical { border-left-color: var(--danger); background: rgba(239, 68, 68, 0.05); }
        .user-role-badge { font-size: 9px; background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        .input-area { padding: 15px 25px; border-top: 1px solid #2d3748; background: var(--bg-deep); }
        .message-row { display: flex; gap: 12px; align-items: center; }
        .msg-box { flex: 1; background: var(--bg-card); border: 1px solid #2d3748; padding: 10px 20px; border-radius: 30px; color: white; outline: none; }
        .action-btn { border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 50%; width: 42px; height: 42px; background: var(--accent); color: white; }
        .btn-sos { background: var(--danger); width: auto; padding: 0 25px; border-radius: 25px; font-weight: 800; }
        .btn-side { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #2d3748; background: #1e293b; color: white; cursor: pointer; margin-top: 10px; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-card); padding: 30px; border-radius: 20px; width: 350px; border: 1px solid #334155; text-align: center; }
        .modal-input { width: 100%; background: #0b0f1a; border: 1px solid #334155; padding: 12px; border-radius: 10px; color: white; margin-bottom: 15px; outline: none; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-left">
        <div class="logo-box">
            <div class="logo-icon">üì°</div>
            <div class="logo-text">Crisis<span>Connect</span></div>
        </div>
    </div>
    <div class="nav-right">
        <div class="nav-stats">
            <div class="stat-item"><span class="stat-val" id="userCount">0</span><span class="stat-lbl">Active</span></div>
            <div class="stat-item"><span class="stat-val" id="messageCount">0</span><span class="stat-lbl">Messages</span></div>
            <div class="stat-item"><span class="stat-val" id="criticalCount" style="color: var(--danger);">0</span><span class="stat-lbl">Critical</span></div>
        </div>
        <div class="notif-wrapper" onclick="toggleNotifDropdown(event)">
            üîî <span class="notif-badge" id="notifBadge">0</span>
            <div class="notif-dropdown" id="notifDropdown"><div id="notifList"></div></div>
        </div>
        <div class="online-indicator">
            <div class="status-dot online" id="onlineDot"></div>
            <span class="status-label" id="statusLabel">Online</span>
        </div>
        <button class="action-btn btn-settings" onclick="toggleSettingsModal(true)">‚öôÔ∏è</button>
    </div>
</div>

<div class="app-main">
    <div class="sidebar">
        <div style="background: #0b0f1a; padding: 12px; border-radius: 12px; border: 1px solid #2d3748; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 11px; font-weight: 700; color: var(--danger);">SOS Filter</span>
            <input type="checkbox" id="emergencyToggle" onchange="toggleEmergencyFilter()">
        </div>
        <span class="side-label">My Status</span>
        <select class="status-dropdown" id="myStatus" onchange="updateMyStatus()">
            <option value="SAFE">‚úÖ Stable / Safe</option>
            <option value="NEED_HELP">‚ö†Ô∏è Need Help</option>
            <option value="CRITICAL">üö® CRITICAL SOS</option>
        </select>
        <span class="side-label">üìä Live Updates</span>
        <div id="statusBoard" style="flex: 1; overflow-y: auto;"></div>
        <button class="btn-side" onclick="toggleQRModal(true)">üì± Connect Phone</button>
    </div>

    <div class="chat-container">
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <div style="display: flex; gap: 8px; padding-bottom: 10px; overflow-x: auto;">
                <button class="quick-bubble" style="background: #22c55e;" onclick="sendQuickMessage('I am safe ‚úÖ')">Safe ‚úÖ</button>
                <button class="quick-bubble" style="background: #3b82f6;" onclick="sendQuickMessage('Need Help ‚ö†Ô∏è')">Help ‚ö†Ô∏è</button>
                <button class="quick-bubble" style="background: #a855f7;" onclick="sendQuickMessage('Need Medical Assistance ü©∫')">Medical ü©∫</button>
                <button class="quick-bubble" style="background: #06b6d4;" onclick="sendQuickMessage('Need Food/Water ü•§')">Food/Water ü•§</button>
                <button class="quick-bubble" style="background: #f97316;" onclick="sendQuickMessage('Fire Emergency! üî•')">Fire üî•</button>
                <button class="quick-bubble" style="background: #64748b;" onclick="sendQuickMessage('Road Blocked üöß')">Block üöß</button>
                <button class="quick-bubble" style="background: #ef4444;" onclick="sendQuickMessage('Trapped/Stuck! üèöÔ∏è')">Trapped üèöÔ∏è</button>
            </div>
            <div class="message-row">
                <button onclick="clearFrontendChat()" class="action-btn btn-settings">üóëÔ∏è</button>
                <button onclick="shareLocation()" class="action-btn btn-settings">üìç</button>
                <input type="text" id="messageInput" class="msg-box" placeholder="Message..." onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" class="action-btn">‚û§</button>
                <button onclick="sendEmergency()" class="action-btn btn-sos">SOS</button>
            </div>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <h3>Profile Settings</h3><br>
        <input type="text" id="userName" class="modal-input" placeholder="Your Name">
        <input type="text" id="userArea" class="modal-input" placeholder="Area">
        <select id="userRole" class="modal-input">
            <option value="Citizen">Citizen</option>
            <option value="Volunteer">Volunteer</option>
            <option value="Doctor">Doctor</option>
        </select>
        <select id="alarmSelect" class="modal-input">
            <option value="https://actions.google.com/sounds/v1/alarms/emergency_it_is_done.ogg">üö® Siren</option>
            <option value="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">üì¢ Beep</option>
        </select>
        <button class="btn-side" style="background: var(--accent); border:none;" onclick="saveSettings()">Save</button>
        <button onclick="toggleSettingsModal(false)" style="margin-top:10px; background:none; border:none; color:var(--text-p); cursor:pointer;">Close</button>
    </div>
</div>

<div id="profileModal" class="modal">
    <div class="modal-content">
        <div id="profAvatar" style="width:60px; height:60px; border-radius:50%; margin: 0 auto 10px; display:flex; align-items:center; justify-content:center; color:white; font-weight:800; font-size:24px;"></div>
        <h2 id="profName"></h2>
        <p id="profRole" style="color:var(--accent); font-weight:700; font-size:12px;"></p><br>
        <div style="text-align:left; font-size:14px;">
            <p>Area: <span id="profArea"></span></p>
            <p>Status: <span id="profStatus"></span></p>
        </div><br>
        <button class="btn-side" onclick="toggleProfileModal(false)">Close</button>
    </div>
</div>

<div id="qrModal" class="modal">
    <div class="modal-content">
        <h3>Join Network</h3>
        <div id="qrcode" style="padding:15px; background:white; display:inline-block; margin:15px 0; border-radius:10px;"></div>
        <p id="qrLinkText" style="font-size:10px; color:var(--accent); word-break:break-all;"></p><br>
        <button onclick="toggleQRModal(false)" class="btn-side">Close</button>
    </div>
</div>

<script>
    // --- ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶è‡¶á ‡¶Ö‡¶Ç‡¶∂‡¶ü‡ßÅ‡¶ï‡ßÅ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ---
    const pcName = "CrisisConnect.local";
    const currentHost = window.location.hostname;

    // ‡¶Ø‡¶¶‡¶ø localhost ‡¶è ‡¶•‡¶æ‡¶ï‡ßá‡¶® ‡¶§‡¶¨‡ßá ‡¶™‡¶ø‡¶∏‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá, ‡¶®‡¶æ‡¶π‡¶≤‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶π‡ßã‡¶∏‡ßç‡¶ü (‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
    const finalHost = (currentHost === "localhost" || currentHost === "127.0.0.1")
                       ? pcName
                       : currentHost;

    const serverUrl = `http://${finalHost}:8080/ws-crisis`;
    const mobileLink = `http://${finalHost}:8080`;

    console.log("Connecting to:", serverUrl);

    // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤ ‡¶†‡¶ø‡¶ï ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
    let stompClient = null;
    let unreadCount = 0;
    let myCoords = null;
    let activeUsersData = {};
    let selectedAlarm = localStorage.getItem('alarm_sound') || 'https://actions.google.com/sounds/v1/alarms/emergency_it_is_done.ogg';

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
            myCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        }, null, { enableHighAccuracy: true });
    }

    let myIdSuffix = sessionStorage.getItem('user_id_suffix') || Math.floor(1000 + Math.random() * 9000);
    sessionStorage.setItem('user_id_suffix', myIdSuffix);

    document.getElementById('userName').value = localStorage.getItem('chat_name') || "";
    document.getElementById('userArea').value = localStorage.getItem('chat_area') || "";
    document.getElementById('userRole').value = localStorage.getItem('chat_role') || "Citizen";
    document.getElementById('alarmSelect').value = selectedAlarm;

    function playTimedAlarm() {
        const audio = new Audio(selectedAlarm);
        audio.play().catch(e => {});
        setTimeout(() => { audio.pause(); audio.currentTime = 0; }, 3000);
    }

    function toggleSettingsModal(show) { document.getElementById("settingsModal").style.display = show ? "flex" : "none"; }
    function toggleProfileModal(show) { document.getElementById("profileModal").style.display = show ? "flex" : "none"; }

    function toggleNotifDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('notifDropdown');
        const badge = document.getElementById('notifBadge');
        const isOpening = dropdown.style.display !== 'block';
        dropdown.style.display = isOpening ? 'block' : 'none';
        if(isOpening) { unreadCount = 0; badge.style.display = 'none'; }
    }

    window.onclick = () => document.getElementById('notifDropdown').style.display = 'none';

    function toggleQRModal(show) {
        document.getElementById("qrModal").style.display = show ? "flex" : "none";
        if(show) generateQRCode();
    }

    // QR Code ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function generateQRCode() {
        const qrContainer = document.getElementById("qrcode");
        if (qrContainer && typeof QRCode !== 'undefined') {
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, {
                text: mobileLink,
                width: 160,
                height: 160,
                correctLevel: QRCode.CorrectLevel.H
            });
            const linkText = document.getElementById("qrLinkText");
            if (linkText) linkText.textContent = mobileLink;
        }
    }

    function getAvatarColor(str) {
        let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];
        return colors[Math.abs(hash) % colors.length];
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        if (!lat1 || !lat2) return null;
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(2);
    }

    function connect() {
        const socket = new SockJS(serverUrl);
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, () => {
            setOnlineStatus(true);
            stompClient.subscribe('/topic/status', res => handleStatusUpdate(JSON.parse(res.body)));
            stompClient.subscribe('/topic/messages', res => displayMessage(JSON.parse(res.body)));
            stompClient.subscribe('/topic/userCount', res => document.getElementById('userCount').textContent = res.body);
            loadData();
        }, () => { setOnlineStatus(false); setTimeout(connect, 5000); });
    }

    function setOnlineStatus(isOnline) {
        const dot = document.getElementById('onlineDot');
        const label = document.getElementById('statusLabel');
        dot.className = isOnline ? "status-dot online" : "status-dot offline";
        label.textContent = isOnline ? "Online" : "Offline";
        label.className = isOnline ? "status-label" : "status-label offline-text";
    }

    function saveSettings() {
        localStorage.setItem('chat_name', document.getElementById('userName').value);
        localStorage.setItem('chat_area', document.getElementById('userArea').value);
        localStorage.setItem('chat_role', document.getElementById('userRole').value);
        selectedAlarm = document.getElementById('alarmSelect').value;
        localStorage.setItem('alarm_sound', selectedAlarm);
        toggleSettingsModal(false);
        updateMyStatus();
    }

    function openUserProfile(userId) {
        const data = activeUsersData[userId];
        if(!data) return;
        const nameOnly = data.userName.split('#')[0];
        document.getElementById('profAvatar').textContent = nameOnly.charAt(0);
        document.getElementById('profAvatar').style.background = getAvatarColor(nameOnly);
        document.getElementById('profName').textContent = nameOnly;
        document.getElementById('profRole').textContent = data.role || 'Citizen';
        document.getElementById('profArea').textContent = data.area || 'Local';
        document.getElementById('profStatus').textContent = data.status || 'SAFE';
        toggleProfileModal(true);
    }

    function handleStatusUpdate(entry) {
        if(!entry || !entry.userName) return;
        activeUsersData[entry.userName] = entry;
        const board = document.getElementById('statusBoard');
        const safeId = 'card-' + btoa(entry.userName).replace(/=/g, '');
        let el = document.getElementById(safeId);
        const isCrit = entry.status === 'CRITICAL';
        if (isCrit && (!el || !el.classList.contains('critical'))) playTimedAlarm();
        if (!el) {
            el = document.createElement('div');
            el.id = safeId;
            el.onclick = () => openUserProfile(entry.userName);
            board.prepend(el);
        }
        const displayName = entry.userName.split('#')[0];
        el.className = `status-card ${isCrit ? 'critical' : (entry.status === 'NEED_HELP' ? 'need-help' : '')}`;
        el.innerHTML = `<span class="user-name">${displayName} <span class="user-role-badge">${entry.role || 'User'}</span></span><br><span style="font-size:11px; opacity:0.8;">${entry.status} ‚Ä¢ ${entry.area || "Local"}</span>`;
        updateCounters();
    }

  function displayMessage(msg) {
    if (!msg) return;
    let cleanText = (msg.content || "").replace(/\[Auto-Filtered\]\s*/g, "").trim();
    const msgId = "msg-" + Date.now() + Math.floor(Math.random() * 1000);

    if(!activeUsersData[msg.senderName]) {
        activeUsersData[msg.senderName] = { userName: msg.senderName, role: msg.senderRole, area: msg.senderArea, status: 'ACTIVE' };
    }

    const myFullName = (localStorage.getItem('chat_name') || "Anonymous") + "#" + myIdSuffix;
    const isMe = msg.senderName === myFullName;
    const senderOnly = msg.senderName.split('#')[0];
    const isSOS = msg.type === 'EMERGENCY';

    // SOS ‡¶π‡¶≤‡ßá ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶Æ ‡¶¨‡¶æ‡¶ú‡¶¨‡ßá
    if (isSOS && !isMe) playTimedAlarm();

    // --- ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶∂‡ßÅ‡¶∞‡ßÅ ---
    if (!isMe && window.Notification && Notification.permission === "granted") {
        new Notification(`CrisisConnect: ${senderOnly}`, {
            body: isSOS ? `üö® SOS: ${cleanText}` : cleanText,
            icon: 'https://cdn-icons-png.flaticon.com/512/1828/1828304.png'
        }).onclick = () => { window.focus(); };
    }
    // --- ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶∂‡ßá‡¶∑ ---

    let locationCard = "";
    if (cleanText.includes("google.com")) {
        const coords = cleanText.match(/(-?\d+\.\d+),(-?\d+\.\d+)/);
        if (coords) {
            const lat = coords[1]; const lon = coords[2];
            let dist = myCoords ? calculateDistance(myCoords.lat, myCoords.lon, parseFloat(lat), parseFloat(lon)) : null;
            locationCard = `<div style="margin-top:8px; padding:8px; background:rgba(255,255,255,0.1); border-radius:8px;">${dist ? `<span style="color:var(--warning); font-size:10px;">üìç ${dist} km away</span>` : ''}<a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" style="display:block; background:var(--accent); color:white; text-align:center; padding:5px; border-radius:5px; text-decoration:none; font-size:11px; margin-top:5px;">Open Map</a></div>`;
            cleanText = "üìç Shared Location";
        }
    }

    const chat = document.getElementById('messages');
    const wrap = document.createElement('div');
    wrap.id = msgId;

    ‡ßá
    wrap.className = isSOS ? 'msg-wrap emergency' : `msg-wrap ${isMe ? 'msg-right' : 'msg-left'}`;

    const avatar = `<div class="msg-avatar" onclick="openUserProfile('${msg.senderName}')" style="background:${getAvatarColor(senderOnly)}">${senderOnly.charAt(0)}</div>`;

    wrap.innerHTML = `
        ${!isMe ? avatar : (isSOS ? avatar : '')}
        <div class="msg-content-box">
            <span class="msg-sender" onclick="openUserProfile('${msg.senderName}')" style="cursor:pointer">${isMe ? 'You' : senderOnly} ${isSOS ? 'üö®' : ''}</span>
            <div class="msg-bubble">${cleanText}${locationCard}</div>
            <span class="msg-time">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
        </div>
        ${isMe && !isSOS ? avatar : ''}
    `;

    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;

    if (!isMe) {
        unreadCount++;
        const badge = document.getElementById('notifBadge');
        badge.textContent = unreadCount; badge.style.display = 'block';
        const notifItem = document.createElement('div');
        notifItem.className = 'notif-item';
        notifItem.onclick = () => scrollToMessage(msgId);
        notifItem.innerHTML = `<span class="notif-user">${isSOS ? 'üö® SOS: ' : ''}${senderOnly}</span><span class="notif-msg">${cleanText.substring(0, 30)}...</span>`;
        document.getElementById('notifList').prepend(notifItem);
    }
    updateCounters();
}
    function showNotification(msg) {
    if (Notification.permission === "granted") {
        const senderOnly = msg.senderName.split('#')[0];

        // ‡¶Ø‡¶¶‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶®‡¶æ ‡¶π‡ßü, ‡¶§‡¶¨‡ßá‡¶á ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶Ü‡¶∏‡¶¨‡ßá
        const myFullName = (localStorage.getItem('chat_name') || "Anonymous") + "#" + myIdSuffix;
        if (msg.senderName !== myFullName) {
            const notification = new Notification(`New Message from ${senderOnly}`, {
                body: msg.content,
                icon: 'https://cdn-icons-png.flaticon.com/512/1828/1828304.png'
            });

         ‡ßá
            notification.onclick = function() {
                window.focus();
                this.close();
            };
        }
    }
}

    function scrollToMessage(id) {
        const el = document.getElementById(id);
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const bubble = el.querySelector('.msg-bubble');
            bubble.style.boxShadow = "0 0 20px var(--accent)";
            setTimeout(() => bubble.style.boxShadow = "none", 2000);
            document.getElementById('notifDropdown').style.display = 'none';
        }
    }

    function toggleEmergencyFilter() {
        document.getElementById('messages').classList.toggle('filter-on', document.getElementById('emergencyToggle').checked);
    }

    function updateCounters() {
        document.getElementById('criticalCount').textContent = document.querySelectorAll('.status-card.critical').length;
        document.getElementById('messageCount').textContent = document.querySelectorAll('.msg-wrap').length;
    }

    function sendMessage() {
        const name = localStorage.getItem('chat_name');
        const text = document.getElementById('messageInput').value.trim();
        if(!name) return toggleSettingsModal(true);
        if(text) {
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                senderName: name + "#" + myIdSuffix, content: text, type: 'TEXT',
                senderRole: localStorage.getItem('chat_role'), senderArea: localStorage.getItem('chat_area')
            }));
            document.getElementById('messageInput').value = '';
        }
    }

    function sendEmergency() {
        const name = localStorage.getItem('chat_name'); if(!name) return toggleSettingsModal(true);
        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
            senderName: name + "#" + myIdSuffix, content: "üö® EMERGENCY! I need immediate help!", type: 'EMERGENCY',
            senderRole: localStorage.getItem('chat_role'), senderArea: localStorage.getItem('chat_area')
        }));
    }

    function sendQuickMessage(text) {
        const name = localStorage.getItem('chat_name'); if(!name) return toggleSettingsModal(true);
        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
            senderName: name + "#" + myIdSuffix, content: text, type: 'TEXT',
            senderRole: localStorage.getItem('chat_role'), senderArea: localStorage.getItem('chat_area')
        }));
    }

    function updateMyStatus() {
        const name = localStorage.getItem('chat_name'); if (!name) return;
        stompClient.send("/app/status.update", {}, JSON.stringify({
            userId: name + "#" + myIdSuffix, userName: name + "#" + myIdSuffix,
            status: document.getElementById('myStatus').value,
            area: localStorage.getItem('chat_area') || "Local",
            role: localStorage.getItem('chat_role') || "Citizen"
        }));
    }

    function shareLocation() {
        const name = localStorage.getItem('chat_name'); if(!name) return toggleSettingsModal(true);
        navigator.geolocation.getCurrentPosition(pos => {
            const mapLink = `https://maps.google.com/?q=${pos.coords.latitude},${pos.coords.longitude}`;
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                senderName: name + "#" + myIdSuffix, content: `üìç My Location: ${mapLink}`, type: 'TEXT',
                senderRole: localStorage.getItem('chat_role'), senderArea: localStorage.getItem('chat_area')
            }));
        }, () => alert("Enable GPS."));
    }

    function clearFrontendChat() { document.getElementById('messages').innerHTML = ''; updateCounters(); }

    async function loadData() {
        try {
            // ‡¶Ü‡¶á‡¶™‡¶ø-‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá finalHost ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
            const s = await fetch(`http://${finalHost}:8080/api/status`).then(r => r.json());
            if(Array.isArray(s)) { document.getElementById('statusBoard').innerHTML = ''; s.forEach(handleStatusUpdate); }
            const m = await fetch(`http://${finalHost}:8080/api/messages/recent`).then(r => r.json());
            if(Array.isArray(m)) m.forEach(displayMessage);
        } catch (e) {}
    }

    window.addEventListener('online', () => setOnlineStatus(true));
    window.addEventListener('offline', () => setOnlineStatus(false));

‡ßá
    window.onload = () => {
        connect();
        generateQRCode();
    };
</script>
</body>
</html>
