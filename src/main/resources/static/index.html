<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrisisConnect - Disaster Messaging</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; height: 100vh; overflow: hidden; }
        .container { display: grid; grid-template-columns: 300px 1fr; grid-template-rows: 60px 1fr; height: 100vh; }
        .header { grid-column: 1 / -1; background: rgba(255, 255, 255, 0.95); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .header h1 { font-size: 24px; color: #667eea; }
        .header .stats { display: flex; gap: 20px; }
        .stat-value { font-size: 20px; font-weight: bold; color: #667eea; text-align: center; }
        .stat-label { font-size: 12px; color: #666; }
        .sidebar { background: rgba(255, 255, 255, 0.95); padding: 20px; overflow-y: auto; }
        .main { display: flex; flex-direction: column; background: rgba(255, 255, 255, 0.9); margin: 10px; border-radius: 10px; overflow: hidden; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }

        /* Message Styles */
        .message { padding: 12px 16px; background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .message.emergency { background: #dc3545 !important; color: white !important; border: 2px solid #ffeb3b; font-weight: bold; }

        .input-area { padding: 20px; background: white; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; }
        textarea { flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; resize: none; }

        /* Buttons */
        button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* SOS Blinking Animation */
        @keyframes sos-blink {
            0% { background-color: #dc3545; box-shadow: 0 0 0px #dc3545; }
            50% { background-color: #ff0000; box-shadow: 0 0 15px #ff0000; transform: scale(1.02); }
            100% { background-color: #dc3545; box-shadow: 0 0 0px #dc3545; }
        }
        .btn-emergency { animation: sos-blink 1s infinite; background: #dc3545 !important; }

        .connection-status { padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .connected { background: #28a745; color: white; }
        .disconnected { background: #dc3545; color: white; }
        .status-item { padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #28a745; }
        .status-item.critical { border-left-color: #dc3545; background: #fff5f5; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üö® CrisisConnect</h1>
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="userCount">0</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="messageCount">0</div>
                <div class="stat-label">Messages</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="criticalCount">0</div>
                <div class="stat-label">Critical</div>
            </div>
        </div>
        <div class="connection-status disconnected" id="status">Disconnected</div>
    </div>

    <div class="sidebar">
        <div style="margin-bottom: 20px;">
            <h3>My Status</h3>
            <select id="myStatus" onchange="updateMyStatus()" style="width: 100%; padding: 8px; margin-top: 10px;">
                <option value="SAFE">‚úÖ Safe</option>
                <option value="NEED_HELP">‚ö†Ô∏è Need Help</option>
                <option value="INJURED">ü§ï Injured</option>
                <option value="CRITICAL">üö® Critical</option>
            </select>
        </div>
        <div class="status-section">
            <h2>üìä Status Board</h2>
            <div class="status-list" id="statusList"></div>
        </div>
    </div>

    <div class="main">
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                <input type="text" id="userName" placeholder="Your name" style="padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0;">
                <div style="display: flex; gap: 10px;">
                    <textarea id="messageInput" placeholder="Type your message..."></textarea>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="sendMessage()">Send</button>
                        <button class="btn-emergency" onclick="sendEmergency()">üö® SOS</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let userId = 'user-' + Math.random().toString(36).substr(2, 9);
    let messageCount = 0;


    function connect() {
        const socket = new SockJS('http://localhost:8080/ws-crisis');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function(frame) {
            document.getElementById('status').textContent = 'Connected';
            document.getElementById('status').className = 'connection-status connected';

            stompClient.subscribe('/topic/messages', function(message) {
                displayMessage(JSON.parse(message.body));
            });

            stompClient.subscribe('/topic/status', function(status) {
                updateStatusBoard(JSON.parse(status.body));
            });
        }, function(error) {
            document.getElementById('status').textContent = 'Disconnected';
            document.getElementById('status').className = 'connection-status disconnected';
            setTimeout(connect, 5000);
        });
    }


    function displayMessage(msg) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message' + (msg.type === 'EMERGENCY' ? ' emergency' : '');

        const time = new Date(msg.timestamp).toLocaleTimeString();
        messageDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 5px; opacity: 0.8;">
                <b>${msg.senderName}</b> <span>${time}</span>
            </div>
            <div style="font-size: 14px;">${msg.content}</div>
        `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }


    function loadData() {
        // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶°
        fetch('http://localhost:8080/api/messages')
            .then(res => res.json())
            .then(data => {
                document.getElementById('messages').innerHTML = '';
                data.forEach(msg => displayMessage(msg));
            });


        fetch('http://localhost:8080/api/status')
            .then(res => res.json())
            .then(data => {
                document.getElementById('statusList').innerHTML = '';
                data.forEach(entry => updateStatusBoard(entry));
            });

        updateStats();
    }


function sendMessage() {
    const contentInput = document.getElementById('messageInput');
    const nameInput = document.getElementById('userName');

    const message = {
        senderName: nameInput.value, // Java field 'senderName' er sathe milte hobe
        content: contentInput.value,
        type: 'TEXT',
        senderId: userId,
        timestamp: new Date().toISOString()
    };

    fetch('/api/messages/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(message)
    }).then(res => {
        if(res.ok) {
            console.log("Saved to database!");
            loadData(); // Database theke history abar load korbe
        }
    });
    contentInput.value = '';
}

    function sendEmergency() {
        const nameInput = document.getElementById('userName');
        if (!nameInput.value.trim()) {
            alert('Please enter your name first!');
            return;
        }

        const message = {
            senderId: userId,
            senderName: nameInput.value.trim(),
            content: 'üö® EMERGENCY! I need immediate help!',
            type: 'EMERGENCY',
            priority: 'CRITICAL',
            timestamp: new Date().toISOString()
        };

        fetch('http://localhost:8080/api/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(message)
        }).then(() => {
            // SOS ‡¶ö‡¶æ‡¶™‡¶≤‡ßá ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ CRITICAL ‡¶π‡¶¨‡ßá
            updateStatusAPI('CRITICAL', 'üö® SOS Pressed!');
        });
    }


    function updateMyStatus() {
        const statusValue = document.getElementById('myStatus').value;
        const statusText = document.getElementById('myStatus').options[document.getElementById('myStatus').selectedIndex].text;
        updateStatusAPI(statusValue, statusText);
    }

    function updateStatusAPI(status, message) {
        const nameInput = document.getElementById('userName');
        if (!nameInput.value.trim()) return;

        const statusEntry = {
            userId: userId,
            userName: nameInput.value.trim(),
            status: status,
            message: message,
            timestamp: new Date().toISOString()
        };

        fetch('http://localhost:8080/api/status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(statusEntry)
        });
    }

    function updateStatusBoard(statusEntry) {
        let statusItem = document.getElementById('status-' + statusEntry.userId);
        if (!statusItem) {
            statusItem = document.createElement('div');
            statusItem.id = 'status-' + statusEntry.userId;
            document.getElementById('statusList').appendChild(statusItem);
        }
        statusItem.className = 'status-item' + (statusEntry.status === 'CRITICAL' ? ' critical' : '');
        statusItem.innerHTML = `<b>${statusEntry.userName}</b>: ${statusEntry.status}`;
        updateStats();
    }

    function updateStats() {
        fetch('http://localhost:8080/api/stats')
            .then(res => res.json())
            .then(stats => {
                document.getElementById('userCount').textContent = stats.activeUsers || 0;
                document.getElementById('messageCount').textContent = stats.totalMessages || 0;
                document.getElementById('criticalCount').textContent = stats.criticalUsers || 0;
            });
    }

    window.onload = function() {
        loadData();
        connect();
        setInterval(updateStats, 5000);
    };
</script>
let stompClient = null;
let userId = 'user-' + Math.random().toString(36).substr(2, 9);

function connect() {
const socket = new SockJS('/ws-crisis');
stompClient = Stomp.over(socket);
stompClient.debug = null;

stompClient.connect({}, function(frame) {
document.getElementById('status').textContent = 'Connected';
document.getElementById('status').className = 'connection-status connected';

// Subscribe topic must match @SendTo in Controller
stompClient.subscribe('/topic/public', function(message) {
displayMessage(JSON.parse(message.body));
});
}, function(error) {
document.getElementById('status').textContent = 'Disconnected';
document.getElementById('status').className = 'connection-status disconnected';
setTimeout(connect, 5000);
});
}

function sendMessage() {
const contentInput = document.getElementById('messageInput');
const nameInput = document.getElementById('userName');

const message = {
senderName: nameInput.value,
content: contentInput.value,
type: 'TEXT',
senderId: userId,
timestamp: new Date().toISOString()
};

fetch('/api/messages/send', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(message)
}).then(res => {
if(res.ok) {
console.log("Saved to database!");
loadData();
}
});
contentInput.value = '';
}

function loadData() {
// Message history fetch korar endpoint
fetch('/api/messages/history')
.then(res => res.json())
.then(data => {
document.getElementById('messages').innerHTML = '';
data.forEach(msg => displayMessage(msg));
});
}



</script>
</body>
</html>